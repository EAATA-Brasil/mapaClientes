<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Mapa de Clientes</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    body { margin: 0; padding: 0; font-family: Arial, sans-serif; transition: overflow 0.3s ease; }
    body.no-scroll { overflow: hidden; }
    #map { height: 100vh; width: 100%; }

    /* TOP SEARCH BAR */
    .topbar {
      position: absolute;
      top: 14px;
      left: 14px;
      right: 14px;
      z-index: 1200;
      display: flex;
      gap: 10px;
      align-items: stretch;
      pointer-events: none;
    }

    .search-wrap {
      pointer-events: auto;
      flex: 1;
      max-width: 720px;
      margin: 0 auto;
      background: #fff;
      border-radius: 14px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.18);
      overflow: hidden;
      border: 1px solid rgba(0,0,0,0.08);
    }

    .search-row {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 12px;
    }

    .search-icon {
      width: 18px;
      height: 18px;
      opacity: .65;
      flex: 0 0 auto;
    }

    #searchInput {
      border: none;
      outline: none;
      width: 100%;
      font-size: 15px;
      padding: 6px 2px;
    }

    .search-actions {
      display: flex;
      gap: 8px;
      align-items: center;
      flex: 0 0 auto;
    }

    .chip {
      border: 1px solid rgba(0,0,0,0.12);
      background: #fafafa;
      border-radius: 999px;
      padding: 7px 10px;
      font-size: 13px;
      cursor: pointer;
      transition: transform .08s, background .15s;
      user-select: none;
      white-space: nowrap;
    }
    .chip:hover { background: #f2f2f2; transform: translateY(-1px); }
    .chip:active { transform: translateY(0); }

    .filters-row {
      display: flex;
      gap: 10px;
      padding: 10px 12px 12px;
      border-top: 1px solid rgba(0,0,0,0.06);
      background: linear-gradient(#fff, #fbfbfb);
      align-items: end;
    }

    .filter-group { flex: 1; display:flex; flex-direction:column; gap:6px; }
    .filter-label { font-size: 12px; color: #666; font-weight: 600; }
    .filter-count { font-size: 11px; color: #999; margin-left:6px; }

    .filter-actions { display:flex; gap:8px; align-items:center; }
    .filter-chip-wrap { display:flex; gap:8px; align-items:center; }
    .chip-group { display:flex; flex-direction:column; gap:6px; }
    .chips-header { font-size:11px; color:#666; font-weight:700; margin-bottom:4px; }
    .active-filters { display:flex; gap:8px; align-items:center; overflow:auto; max-width:260px; }

    .filters-row select {
      width: 100%;
      border: 1px solid rgba(0,0,0,0.08);
      border-radius: 10px;
      padding: 10px 12px;
      font-size: 14px;
      outline: none;
      background: linear-gradient(#fff, #fafafa);
      box-shadow: 0 1px 0 rgba(0,0,0,0.02) inset;
      transition: border-color 0.12s, box-shadow 0.12s, transform 0.06s;
    }
    .filters-row select:focus { border-color: #009ee0; box-shadow: 0 2px 12px rgba(0,158,224,0.08); transform: translateY(-1px); }

    .filter-chip { padding: 6px 8px; border-radius: 999px; font-size: 13px; display:inline-flex; gap:8px; align-items:center; border:1px solid rgba(0,0,0,0.06); }
    .filter-chip button { background: transparent; border: none; cursor:pointer; font-weight:700; font-size:12px; padding:0; margin-left:6px; }

    .filter-chip.state { background: #fff8e6; color:#b06900; border-color: rgba(176,123,0,0.12); }
    .filter-chip.city { background: #eef9ff; color: #0077b8; border-color: rgba(0,118,170,0.12); }

    .filter-count-badge { background:#f0f4f8; color:#666; padding:4px 8px; border-radius:999px; font-size:12px; border:1px solid rgba(0,0,0,0.04); }


    .meta-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0 12px 10px;
      color: #555;
      font-size: 12.5px;
    }

    .results {
      max-height: 320px;
      overflow: auto;
      border-top: 1px solid rgba(0,0,0,0.06);
      display: none;
      background: #fff;
    }
    .results.show { display: block; }

    .result-item {
      padding: 10px 12px;
      cursor: pointer;
      border-bottom: 1px solid rgba(0,0,0,0.06);
      transition: background .12s;
    }
    .result-item:hover { background: #f7f7f7; }
    .result-title { font-weight: 700; font-size: 14px; color: #1f1f1f; }
    .result-sub { font-size: 12.5px; color: #666; margin-top: 2px; }

    /* Locate button */
    .locate-btn {
        position: absolute;
        bottom: 80px;
        right: 20px;
        background-color: #fff;
        border: none;
        border-radius: 50%;
        width: 46px;
        height: 46px;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 2px 6px rgba(0,0,0,0.3);
        cursor: pointer;
        z-index: 1000;
        transition: background-color 0.2s, transform 0.1s;
    }
    .locate-btn:hover { background-color: #f5f5f5; transform: scale(1.05); }
    .locate-btn:active { transform: scale(0.95); }
    .locate-btn svg { width: 22px; height: 22px; fill: #4285F4; }

    .accuracy-warning {
        position: absolute;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        background-color: rgba(0, 0, 0, 0.75);
        color: white;
        padding: 8px 15px;
        border-radius: 4px;
        font-size: 14px;
        z-index: 1000;
        opacity: 0;
        transition: opacity 0.5s ease-in-out;
        pointer-events: none;
    }
    .accuracy-warning.show { opacity: 1; }

    /* Sidebar */
    .sidebar {
        position: fixed;
        top: 0;
        right: 0;
        width: 100%;
        max-width: 400px;
        height: 100%;
        background-color: #fff;
        box-shadow: -4px 0 10px rgba(0,0,0,0.2);
        z-index: 1001;
        transform: translateX(100%);
        transition: transform 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
        overflow-y: auto;
        padding: 20px;
        display: flex;
        flex-direction: column;
    }
    .sidebar.open { transform: translateX(0); }

    .sidebar-close {
        position: sticky;
        top: 0;
        align-self: flex-end;
        font-size: 30px;
        cursor: pointer;
        border: none;
        background: none;
        color: #555;
        padding: 5px;
        margin-right: -10px;
        transition: color 0.2s;
    }
    .sidebar-close:hover { color: #333; }

    .sidebar-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 10px;
        border-bottom: 1px solid #eee;
    }

    .sidebar-content { flex-grow: 1; padding-top: 10px; }

    .photo-gallery {
        display: flex;
        overflow-x: auto;
        gap: 10px;
        margin-bottom: 20px;
        padding-bottom: 10px;
        -webkit-overflow-scrolling: touch;
        scrollbar-width: thin;
        scrollbar-color: #ccc transparent;
    }
    .photo-gallery::-webkit-scrollbar { height: 8px; }
    .photo-gallery::-webkit-scrollbar-thumb { background-color: #ccc; border-radius: 10px; border: 2px solid #fff; }

    .photo-gallery img {
        width: 200px;
        height: 150px;
        object-fit: cover;
        border-radius: 8px;
        flex-shrink: 0;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }

    .info-item { margin-bottom: 12px; line-height: 1.5; color: #444; }
    .info-item strong { color: #222; }
    .info-item a { color: #007bff; }

    @media (max-width: 600px) {
        .sidebar { width: 100%; max-width: 100%; }
        .topbar { left: 10px; right: 10px; }
    }
  </style>
</head>
<body>

  <div id="map"></div>

  <!-- Top search / filters -->
  <div class="topbar">
    <div class="search-wrap">
      <div class="search-row">
        <svg class="search-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
          <path d="M10 2a8 8 0 105.293 14.293l4.707 4.707a1 1 0 001.414-1.414l-4.707-4.707A8 8 0 0010 2zm0 2a6 6 0 110 12 6 6 0 010-12z"/>
        </svg>
        <input id="searchInput" type="text" placeholder="Buscar cliente (nome da oficina/pessoa)…" autocomplete="off" />
        <div class="search-actions">
          <div class="chip" id="clearBtn">Limpar</div>
        </div>
      </div>

      <div class="filters-row">
        <div class="filter-group">
          <label class="filter-label" for="estadoSelect">Estado</label>
          <select id="estadoSelect">
            <option value="">Todos os estados</option>
          </select>
        </div>

        <div class="filter-group">
          <label class="filter-label" for="cidadeSelect">Cidade <span id="cidadeCount" class="filter-count filter-count-badge"></span></label>
          <select id="cidadeSelect">
            <option value="">Todas as cidades</option>
          </select>
        </div>

        <div class="filter-actions">
          <div id="activeFilters" class="filter-chip-wrap" aria-live="polite">
            <div class="chip-group" id="stateChipsWrapper" style="display:none">
              <div class="chips-header">Estados</div>
              <div id="stateChips" class="active-filters" role="list"></div>
            </div>
            <div class="chip-group" id="cityChipsWrapper" style="display:none">
              <div class="chips-header">Cidades</div>
              <div id="cityChips" class="active-filters" role="list"></div>
            </div>
          </div>

          <div class="chip" id="fitBtn">Enquadrar</div>
        </div>
      </div>

      <div class="meta-row">
        <div id="countLabel">Carregando…</div>
        <div id="hintLabel">Digite para ver sugestões</div>
      </div>

      <div class="results" id="results"></div>
    </div>
  </div>

  <button class="locate-btn" id="locateBtn" title="Centralizar em mim">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
          <path d="M12 8a4 4 0 1 0 4 4 4.004 4.004 0 0 0-4-4Zm10 3h-1.071A8.994 8.994 0 0 0 13 3.071V2a1 1 0 0 0-2 0v1.071A8.994 8.994 0 0 0 3.071 11H2a1 1 0 0 0 0 2h1.071A8.994 8.994 0 0 0 11 20.929V22a1 1 0 0 0 2 0v-1.071A8.994 8.994 0 0 0 20.929 13H22a1 1 0 0 0 0-2ZM12 19a7 7 0 1 1 7-7 7.008 7.008 0 0 1-7 7Z"/>
      </svg>
  </button>

  <div id="accuracyWarning" class="accuracy-warning">Não foi possível pegar localização exata</div>

  <!-- Sidebar -->
  <div id="sidebar" class="sidebar">
      <div class="sidebar-header">
          <h2 id="sidebar-title">Detalhes do Cliente</h2>
          <button class="sidebar-close" id="sidebarCloseBtn">&times;</button>
      </div>
      <div id="sidebar-content" class="sidebar-content"></div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    let map;
    let userMarker;
    let userCircle;
    let userPosition = null;

    let clientesRaw = [];
    let clientesView = [];
    let markersLayer = null;
    let markerById = new Map();

    // multi-select state/city sets
    const selectedStates = new Set();
    const selectedCities = new Set();

    const API_URL = "/clientes"; // ✅ seu endpoint
    const ACCURACY_THRESHOLD = 200;

    // elements
    const searchInput = document.getElementById("searchInput");
    const resultsEl = document.getElementById("results");
    const estadoSelect = document.getElementById("estadoSelect");
    const cidadeSelect = document.getElementById("cidadeSelect");
    const countLabel = document.getElementById("countLabel");
    const hintLabel = document.getElementById("hintLabel");
    const clearBtn = document.getElementById("clearBtn");
    const fitBtn = document.getElementById("fitBtn");

    map = L.map("map").setView([-14.235, -51.9253], 4);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      attribution: "&copy; OpenStreetMap contributors"
    }).addTo(map);

    const logoPin = L.divIcon({
      html: `
      <svg viewBox="0 0 192 192" width="75" height="75" xmlns="http://www.w3.org/2000/svg" fill="none">
        <path fill="#009ee0" stroke="#009ee0" stroke-width="7" d="M96 22a59 59 0 0 0-31 10 59 59 0 0 0-22 27 59 59 0 0 0-3 34 59 59 0 0 0 16 30c11 11 36 26 38 43 0 2 2 4 4 4s4-2 4-4c2-17 27-32 38-43a59 59 0 0 0 16-30 59 59 0 0 0-3-34 59 59 0 0 0-22-27 59 59 0 0 0-31-10Z"/>
        <circle cx="96" cy="82" r="54" fill="white" stroke="#009ee0" stroke-width="3"/>
        <clipPath id="cliplogo">
          <circle cx="96" cy="82" r="54"/>
        </clipPath>
        <image href="logo.jpg" x="39" y="20" width="118" height="132" clip-path="url(#cliplogo)" />
      </svg>
      `,
      className: "",
      iconSize: [75, 75],
      iconAnchor: [37.5, 70],
      popupAnchor: [0, -65]
    });

    function safeFotos(fotos) {
      if (!fotos) return [];
      // se backend já manda array
      if (Array.isArray(fotos)) return fotos;
      // se manda como string JSON
      if (typeof fotos === "string") {
        try {
          const parsed = JSON.parse(fotos);
          return Array.isArray(parsed) ? parsed : [];
        } catch { return []; }
      }
      return [];
    }

    function normalizeStr(s) {
      return String(s || "")
        .toLowerCase()
        .normalize("NFD")
        .replace(/[\u0300-\u036f]/g, "")
        .trim();
    }

    async function carregarClientes() {
      try {
        const res = await fetch(API_URL);
        const data = await res.json();

        // guarda tudo (raw)
        clientesRaw = (Array.isArray(data) ? data : [])
          .filter(c => c.latitude && c.longitude)
          .map(c => ({
            id: c.id,
            id_odoo: c.id_odoo,
            nome: c.nome || "Sem nome",
            telefone: c.telefone || "",
            celular: c.celular || "",
            email: c.email || "",
            site: c.site || "",
            cep: c.cep || "",
            estado: (c.estado || "").toString(),
            cidade: (c.cidade || "").toString(),
            bairro: (c.bairro || "").toString(),
            logradouro: (c.logradouro || "").toString(),
            endereco_completo: (c.endereco_completo || "").toString(),
            coords: [Number(c.latitude), Number(c.longitude)],
            fotos: safeFotos(c.fotos),
            equipamentos: Array.isArray(c.equipamentos) ? c.equipamentos : []
          }));

        buildFilters();
        applyFiltersAndRender();
      } catch (err) {
        console.error("Erro ao carregar clientes:", err);
        countLabel.textContent = "Erro ao carregar clientes";
      }
    }

    function buildFilters() {
      // estados únicos
      const estados = [...new Set(clientesRaw.map(c => (c.estado || "").trim()).filter(Boolean))]
        .sort((a,b) => a.localeCompare(b, "pt-BR"));

      estadoSelect.innerHTML = `<option value="">Todos os estados</option>` +
        estados.map(e => `<option value="${e}">${e}</option>`).join("");

      // populate cidades for current estado (if empty => all cities)
      updateCidadesByEstado(estadoSelect.value);

      // render current active filters
      renderActiveFilters();
    }

    function updateCidadesByEstado(estado) {
      // determine active states for filtering (selectedStates union the single estado param if provided)
      const activeStates = selectedStates.size ? Array.from(selectedStates) : (estado ? [estado] : []);

      const cidades = [...new Set(
        clientesRaw
          .filter(c => !activeStates.length || activeStates.includes(c.estado))
          .map(c => (c.cidade || "").trim())
          .filter(Boolean)
      )].sort((a,b) => a.localeCompare(b, "pt-BR"));

      cidadeSelect.innerHTML = `<option value="">Todas as cidades</option>` +
        cidades.map(c => `<option value="${c}">${c}</option>`).join("");

      cidadeSelect.disabled = cidades.length === 0;

      // if we have active states, remove any selected cities that don't belong to them
      if (selectedStates.size) {
        const allowed = new Set(cidades);
        let removedAny = false;
        Array.from(selectedCities).forEach((city) => {
          if (!allowed.has(city)) {
            selectedCities.delete(city);
            removedAny = true;
          }
        });
        if (removedAny) {
          applyFiltersAndRender();
        }
      }

      // update cidade count badge
      const countEl = document.getElementById('cidadeCount');
      if (countEl) countEl.textContent = cidades.length ? `${cidades.length}` : '';

      renderActiveFilters();
    }

    function getFilteredClientes() {
      const q = normalizeStr(searchInput.value);

      const estados = Array.from(selectedStates);
      const cidades = Array.from(selectedCities);

      const filtered = clientesRaw.filter(c => {
        if (estados.length && !estados.includes(c.estado)) return false;
        if (cidades.length && !cidades.includes(c.cidade)) return false;

        if (!q) return true;

        const hay = normalizeStr(
          `${c.nome} ${c.cidade} ${c.estado} ${c.bairro} ${c.cep} ${c.endereco_completo}`
        );

        return hay.includes(q);
      });

      return filtered;
    }

    function applyFiltersAndRender() {
      clientesView = getFilteredClientes();

      countLabel.textContent = `${clientesView.length} cliente(s) no mapa`;
      hintLabel.textContent = "Selecione um resultado para abrir";

      renderMarkers(clientesView);
      renderResultsList();
    }

    function renderMarkers(items) {
      if (markersLayer) {
        markersLayer.clearLayers();
        markerById.clear();
      } else {
        markersLayer = L.layerGroup().addTo(map);
      }

      items.forEach(c => {
        const tooltipContent = `
          <strong>${c.nome}</strong><br>
          ${c.telefone ? `Telefone: ${c.telefone}<br>` : ""}
          ${c.cidade ? `Cidade: ${c.cidade}<br>` : ""}
          ${c.estado ? `Estado: ${c.estado}<br>` : ""}
          ${c.site ? `Site: <a href="${c.site}" target="_blank">${c.site}</a><br>` : ""}
          CEP: ${c.cep || "-"}
        `;

        const marker = L.marker(c.coords, { icon: logoPin })
          .addTo(markersLayer)
          .bindTooltip(tooltipContent, {
            direction: "top",
            offset: [0, -30]
          });

        marker.on("click", () => {
          openSidebar(c);
          map.setView(c.coords, Math.max(map.getZoom(), 14));
        });

        markerById.set(c.id, marker);
      });
    }

    function renderResultsList() {
      const q = normalizeStr(searchInput.value);
      // mostra autocomplete se tiver texto ou filtros ativos (inclui seleção múltipla)
      const show = q.length >= 1 || estadoSelect.value || cidadeSelect.value || selectedStates.size > 0 || selectedCities.size > 0;
      resultsEl.classList.toggle("show", show);
      renderActiveFilters();

      // limita lista pra não ficar gigante
      const list = clientesView.slice(0, 20);

      resultsEl.innerHTML = list.map(c => {
        const sub = [c.cidade, c.estado, c.cep].filter(Boolean).join(" • ");
        return `
          <div class="result-item" data-id="${c.id}">
            <div class="result-title">${c.nome}</div>
            <div class="result-sub">${sub || "—"}</div>
          </div>
        `;
      }).join("");

      // click item
      resultsEl.querySelectorAll(".result-item").forEach(el => {
        el.addEventListener("click", () => {
          const id = Number(el.getAttribute("data-id"));
          const cliente = clientesRaw.find(x => x.id === id);
          if (!cliente) return;

          const marker = markerById.get(id);
          if (marker) marker.openTooltip();

          map.setView(cliente.coords, 15);
          openSidebar(cliente);
          resultsEl.classList.remove("show");
          searchInput.blur();
        });
      });
    }

    function openSidebar(cliente) {
      // keep active filters visible when opening sidebar
      renderActiveFilters();
      const sidebar = document.getElementById("sidebar");
      const sidebarContent = document.getElementById("sidebar-content");
      const sidebarTitle = document.getElementById("sidebar-title");

      sidebarTitle.textContent = cliente.nome;

      let galleryHTML = "";
      if (cliente.fotos && cliente.fotos.length > 0) {
        galleryHTML = '<div class="photo-gallery">';
        cliente.fotos.forEach(url => {
          galleryHTML += `<img src="${url}" alt="Foto de ${cliente.nome}" loading="lazy">`;
        });
        galleryHTML += "</div>";
      }

      const lat = cliente.coords[0];
      const lng = cliente.coords[1];
      const num = cliente.telefone ? cliente.telefone.replace(/\D/g, "") : (cliente.celular ? cliente.celular.replace(/\D/g,"") : null);
      const linkWhats = num ? `https://wa.me/55${num}` : null;

      const endereco = cliente.endereco_completo || [cliente.logradouro, cliente.numero, cliente.bairro, cliente.cidade, cliente.estado, cliente.cep, cliente.pais].filter(Boolean).join(", ");

      const equipHTML = (cliente.equipamentos && cliente.equipamentos.length)
        ? `<div class="info-item"><strong>Equipamentos:</strong><ul style="margin:8px 0 0 18px;padding:0;">${cliente.equipamentos.map(e => `<li>${e.nome}${e.quantidade ? ' — ' + e.quantidade : ''}</li>`).join('')}</ul></div>`
        : `<div class="info-item"><strong>Equipamentos:</strong> Não informado</div>`;

      sidebarContent.innerHTML = `
        ${galleryHTML}
        <div class="info-item"><strong>Telefone:</strong> ${cliente.telefone || "Não informado"}</div>
        <div class="info-item"><strong>Celular:</strong> ${cliente.celular || "Não informado"}</div>
        <div class="info-item"><strong>Email:</strong> ${cliente.email ? `<a href="mailto:${cliente.email}">${cliente.email}</a>` : "Não informado"}</div>
        <div class="info-item"><strong>Endereço:</strong> ${endereco || "Não informado"}</div>
        <div class="info-item"><strong>CEP:</strong> ${cliente.cep || "-"}</div>
        <div class="info-item"><strong>Cidade/UF:</strong> ${(cliente.cidade || "-")} / ${(cliente.estado || "-")}</div>
        <div class="info-item"><strong>Site:</strong> ${cliente.site ? `<a href="${cliente.site}" target="_blank">${cliente.site}</a>` : "Não informado"}</div>

        ${equipHTML}

        <div style="display:flex; gap:10px; margin-top:15px;">
          <a href="https://www.google.com/maps/search/?api=1&query=${lat},${lng}"
            target="_blank"
            style="flex:1; padding:10px; text-align:center; background:#4285F4; color:white; border-radius:10px; text-decoration:none;">
            Abrir no Maps
          </a>

          ${linkWhats ? `
          <a href="${linkWhats}" target="_blank"
            style="flex:1; padding:10px; text-align:center; background:#25D366; color:white; border-radius:10px; text-decoration:none;">
            WhatsApp
          </a>` : ""}
        </div>
      `;

      sidebar.classList.add("open");
      document.body.classList.add("no-scroll");
    }

    document.getElementById("sidebarCloseBtn").addEventListener("click", () => {
      document.getElementById("sidebar").classList.remove("open");
      document.body.classList.remove("no-scroll");
    });

    function showWarning() {
      const warning = document.getElementById("accuracyWarning");
      warning.classList.add("show");
      setTimeout(() => warning.classList.remove("show"), 4000);
    }

    function mostrarLocalizacao() {
      renderActiveFilters();
      if (!navigator.geolocation) {
        alert("Seu navegador não suporta geolocalização.");
        return;
      }

      navigator.geolocation.getCurrentPosition(
        pos => {
          const userLat = pos.coords.latitude;
          const userLng = pos.coords.longitude;
          const accuracy = pos.coords.accuracy;

          userPosition = [userLat, userLng];

          if (userMarker) map.removeLayer(userMarker);
          if (userCircle) map.removeLayer(userCircle);

          userCircle = L.circle(userPosition, {
            radius: accuracy,
            color: "#4285F4",
            fillColor: "#4285F4",
            fillOpacity: 0.2,
            weight: 2
          }).addTo(map);

          if (accuracy > ACCURACY_THRESHOLD) {
            map.setView(userPosition, 16);
            showWarning();
          } else {
            userMarker = L.marker(userPosition, { icon: logoPin })
              .addTo(map)
              .bindPopup("<strong>Você está aqui</strong>")
              .openPopup();

            map.setView(userPosition, 16);
          }
        },
        err => alert("Erro ao obter localização: " + err.message),
        { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
      );
    }

    document.getElementById("locateBtn").addEventListener("click", () => {
      if (userPosition) {
        map.setView(userPosition, 16);
        if (userMarker) userMarker.openPopup();
      } else {
        mostrarLocalizacao();
      }
    });

    // === UI handlers ===
    let searchTimer = null;

    // render small active filter chips
    function renderActiveFilters() {
      const stateWrapper = document.getElementById('stateChipsWrapper');
      const cityWrapper = document.getElementById('cityChipsWrapper');
      const stateContainer = document.getElementById('stateChips');
      const cityContainer = document.getElementById('cityChips');
      if (!stateContainer || !cityContainer || !stateWrapper || !cityWrapper) return;

      stateContainer.innerHTML = '';
      cityContainer.innerHTML = '';

      // states
      Array.from(selectedStates).forEach(state => {
        const el = document.createElement('span');
        el.className = 'filter-chip state';
        el.setAttribute('role', 'listitem');
        const btn = document.createElement('button');
        btn.setAttribute('aria-label', 'Remover filtro de estado');
        btn.title = 'Remover';
        btn.textContent = '×';
        btn.addEventListener('click', () => {
          selectedStates.delete(state);
          updateCidadesByEstado('');
          applyFiltersAndRender();
          renderActiveFilters();
        });
        el.appendChild(document.createTextNode(state + ' '));
        el.appendChild(btn);
        stateContainer.appendChild(el);
      });

      // cities
      Array.from(selectedCities).forEach(city => {
        const el = document.createElement('span');
        el.className = 'filter-chip city';
        el.setAttribute('role', 'listitem');
        const btn = document.createElement('button');
        btn.setAttribute('aria-label', 'Remover filtro de cidade');
        btn.title = 'Remover';
        btn.textContent = '×';
        btn.addEventListener('click', () => {
          selectedCities.delete(city);
          applyFiltersAndRender();
          renderActiveFilters();
        });
        el.appendChild(document.createTextNode(city + ' '));
        el.appendChild(btn);
        cityContainer.appendChild(el);
      });

      stateWrapper.style.display = selectedStates.size ? 'flex' : 'none';
      cityWrapper.style.display = selectedCities.size ? 'flex' : 'none';
    }
    searchInput.addEventListener("input", () => {
      // debounce
      clearTimeout(searchTimer);
      searchTimer = setTimeout(() => {
        applyFiltersAndRender();
      }, 180);
    });

    estadoSelect.addEventListener("change", () => {
      const s = estadoSelect.value;
      if (!s) return;
      // add to selectedStates and reset select so user can add more
      selectedStates.add(s);
      estadoSelect.value = '';
      updateCidadesByEstado('');
      applyFiltersAndRender();
      renderActiveFilters();
    });

    cidadeSelect.addEventListener("change", () => {
      const c = cidadeSelect.value;
      if (!c) return;
      selectedCities.add(c);
      cidadeSelect.value = '';
      applyFiltersAndRender();
      renderActiveFilters();
    });

    clearBtn.addEventListener("click", () => {
      searchInput.value = "";
      estadoSelect.value = "";
      cidadeSelect.value = "";
      selectedStates.clear();
      selectedCities.clear();
      updateCidadesByEstado("");
      resultsEl.classList.remove("show");
      applyFiltersAndRender();
      renderActiveFilters();
    });

    fitBtn.addEventListener("click", () => {
      if (!clientesView.length) return;
      const bounds = L.latLngBounds(clientesView.map(c => c.coords));
      map.fitBounds(bounds, { padding: [40, 40] });
    });

    // NOTA: não escondemos mais a lista ao clicar fora (como no mapa).
    // A lista de resultados permanece visível enquanto houver texto/filtros ativos
    // e só é escondida quando o usuário clica em "Limpar".
    // (Removido handler que removia a classe `show` ao clicar fora.)

    mostrarLocalizacao();
    carregarClientes();
  </script>

</body>
</html>
